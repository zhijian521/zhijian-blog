---
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import BaseHead from '../components/BaseHead.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { encodeCategoryPath, encodeTag } from '../utils/blogTaxonomy';

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: MarkdownHeading[];
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	tags,
	category,
	headings = [],
} = Astro.props as Props;
---

<html lang="zh-CN">
	<head>
		<BaseHead title={title} description={description} />
	</head>
	<body>
		<div class="noise-layer" aria-hidden="true"></div>
		<div class="data-stream" aria-hidden="true"></div>
		<main class="page page-grid page-grid--post page-grid--sticky-side">
			<aside class="side-stack">
				<section class="terminal post-meta-panel post-meta-panel--compact post-toc-panel">
					<div class="terminal-bar">
						<div class="terminal-title">目录</div>
					</div>
					<div class="terminal-body post-toc-body">
						{headings.length ? (
							<ol class="toc-list toc-list--cyber">
								{headings.map((heading) => (
									<li class="toc-item" style={`--depth:${heading.depth}`}>
										<a href={`#${heading.slug}`}>{heading.text}</a>
									</li>
								))}
							</ol>
						) : (
							<p class="hero-sub">暂无目录</p>
						)}
					</div>
				</section>
				<section class="terminal post-meta-info-panel">
					<div class="terminal-bar">
						<div class="terminal-title">元信息</div>
					</div>
					<div class="terminal-body post-meta-body">
						<div class="meta-list post-meta-list">
							<div class="post-meta-item">
								<span class="meta-label">发布日期</span>
								<span class="post-meta-value"><FormattedDate date={pubDate} /></span>
							</div>
							{updatedDate && (
								<div class="post-meta-item">
									<span class="meta-label">更新日期</span>
									<span class="post-meta-value"><FormattedDate date={updatedDate} /></span>
								</div>
							)}
						</div>
						<div class="post-meta-block">
							<p class="meta-label">标签</p>
							{tags?.length ? (
								<div class="tag-list">
									{tags.map((tag) => (
										<a class="tag" href={`/blog/tags/${encodeTag(tag)}/`}>
											#{tag}
										</a>
									))}
								</div>
							) : (
								<p class="hero-sub">暂无标签</p>
							)}
						</div>
						<div class="post-meta-block">
							<p class="meta-label">分类</p>
							{category ? (
								<div class="tag-list">
									<a class="tag" href={`/blog/categories/${encodeCategoryPath(category)}/`}>
										{category}
									</a>
								</div>
							) : (
								<p class="hero-sub">暂无分类</p>
							)}
						</div>
					</div>
				</section>
			</aside>
			<section class="terminal terminal-article">
				<div class="terminal-bar">
					<div class="terminal-title">article</div>
				</div>
				<div class="terminal-body">
					<header class="post-header">
						<h1>{title}</h1>
						<p class="hero-sub">{description}</p>
						<div class="post-meta">
							<FormattedDate date={pubDate} />
							{updatedDate && (
								<span> · 更新于 <FormattedDate date={updatedDate} /></span>
							)}
						</div>
					</header>
					<hr class="divider" />
					<article class="post-content">
						<slot />
					</article>
				</div>
			</section>
		</main>
		<script is:inline>
			(() => {
				const tocBody = document.querySelector('.post-toc-body');
				const tocLinks = Array.from(document.querySelectorAll('.toc-list--cyber a[href^="#"]'));

				if (!tocBody || !tocLinks.length) {
					return;
				}

				const headingMap = new Map();

				tocLinks.forEach((link) => {
					const targetId = decodeURIComponent(link.getAttribute('href')?.slice(1) ?? '');
					if (!targetId) return;
					const target = document.getElementById(targetId);
					if (target && /^H[1-6]$/.test(target.tagName)) {
						headingMap.set(targetId, target);
					}
				});

				if (!headingMap.size) {
					return;
				}

				let activeId = '';

				const setActive = (id) => {
					if (!id || activeId === id) return;
					activeId = id;
					tocLinks.forEach((link) => {
						const linkId = decodeURIComponent(link.getAttribute('href')?.slice(1) ?? '');
						const isActive = linkId === id;
						link.classList.toggle('is-active', isActive);
						if (isActive) {
							link.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
						}
					});
				};

				const getCurrentHeadingId = () => {
					const threshold = window.scrollY + window.innerHeight * 0.28;
					let current = '';
					headingMap.forEach((heading, id) => {
						if (heading.offsetTop <= threshold) {
							current = id;
						}
					});
					return current || Array.from(headingMap.keys())[0];
				};

				let ticking = false;
				const onScroll = () => {
					if (ticking) return;
					ticking = true;
					requestAnimationFrame(() => {
						setActive(getCurrentHeadingId());
						ticking = false;
					});
				};

				tocLinks.forEach((link) => {
					link.addEventListener('click', (event) => {
						event.preventDefault();
						const targetId = decodeURIComponent(link.getAttribute('href')?.slice(1) ?? '');
						const target = headingMap.get(targetId);
						if (!target) return;
						setActive(targetId);
						target.scrollIntoView({ behavior: 'smooth', block: 'start' });
						history.replaceState(null, '', `#${encodeURIComponent(targetId)}`);
					});
				});

				setActive(getCurrentHeadingId());
				window.addEventListener('scroll', onScroll, { passive: true });
				window.addEventListener('resize', onScroll, { passive: true });
			})();
		</script>
	</body>
</html>
