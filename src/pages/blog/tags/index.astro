---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import SidebarNav from '../../../components/SidebarNav.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import { collectTags, encodeTag } from '../../../utils/blogTaxonomy';

const posts = await getCollection('blog');
const tags = collectTags(posts);
const maxCount = Math.max(...tags.map((tag) => tag.count), 1);
const stats = {
	tagCount: tags.length,
	postCount: posts.length,
	withTagCount: posts.filter((post) => (post.data.tags?.length ?? 0) > 0).length,
};
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`${SITE_TITLE} / Tags`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<div class="noise-layer" aria-hidden="true"></div>
		<div class="data-stream" aria-hidden="true"></div>
		<main class="page page-grid page-grid--sticky-side page-grid--sticky-side-auto">
			<aside class="side-stack side-stack--blog-width">
				<SidebarNav
					actions={[
						{ href: '/', label: '首页' },
						{ href: '/blog/', label: '文章列表' },
						{ href: '/blog/categories/', label: '分类索引' },
					]}
				/>
				<section class="terminal sticky-side-panel">
					<div class="terminal-bar">
						<div class="terminal-title">stats</div>
					</div>
					<div class="terminal-body meta-list taxonomy-stats">
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">标签节点</span>
							<span class="taxonomy-stat-value">{stats.tagCount}</span>
						</div>
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">文章总数</span>
							<span class="taxonomy-stat-value">{stats.postCount}</span>
						</div>
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">带标签文章</span>
							<span class="taxonomy-stat-value">{stats.withTagCount}</span>
						</div>
					</div>
				</section>
			</aside>
			<section class="terminal terminal-article">
				<div class="terminal-bar">
					<div class="terminal-title">tags</div>
				</div>
				<div class="terminal-body">
					<h1 class="taxonomy-title">标签索引</h1>
					<p class="hero-sub">共 {tags.length} 个标签，点击查看对应文章集合。</p>
					{tags.length ? (
						<div class="tag-cloud tag-cloud--enhanced">
							{tags.map((tag) => {
								const ratio = tag.count / maxCount;
								const size = (0.92 + ratio * 0.26).toFixed(2);

								return (
									<a
										class="tag tag-cloud-pill"
										href={`/blog/tags/${encodeTag(tag.name)}/`}
										style={`--size:${size}rem;`}
									>
										#{tag.name}
										<span class="tag-cloud-count">{tag.count}篇</span>
									</a>
								);
							})}
						</div>
					) : (
						<p class="hero-sub">暂无标签</p>
					)}
				</div>
			</section>
		</main>
	</body>
</html>
