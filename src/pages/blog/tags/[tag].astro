---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import FormattedDate from '../../../components/FormattedDate.astro';
import SidebarNav from '../../../components/SidebarNav.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import {
	encodeCategoryPath,
	encodeTag,
	getPostPath,
	sortPostsByPriority,
} from '../../../utils/blogTaxonomy';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const tagSet = new Set(posts.flatMap((post) => post.data.tags ?? []));

	return [...tagSet].map((tag) => ({
		params: { tag },
		props: { tag },
	}));
}

type Props = {
	tag: string;
};

const { tag } = Astro.props as Props;
const posts = sortPostsByPriority(await getCollection('blog'));
const filteredPosts = posts.filter((post) => (post.data.tags ?? []).includes(tag));
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`${SITE_TITLE} / Tag / ${tag}`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<div class="noise-layer" aria-hidden="true"></div>
		<div class="data-stream" aria-hidden="true"></div>
		<main class="page page-grid page-grid--sticky-side page-grid--sticky-side-auto">
			<aside class="side-stack side-stack--blog-width" style="--side-panels:1;">
				<SidebarNav
					cyber
					actions={[
						{ href: '/blog/', label: '查看文章列表' },
						{ href: '/blog/tags/', label: '返回标签索引' },
					]}
				>
					<div slot="context" class="nav-cyber-context">
						<p class="nav-cyber-kicker">ACTIVE TAG</p>
						<a class="nav-cyber-pill" href={`/blog/tags/${encodeTag(tag)}/`}>#{tag}</a>
						<p class="nav-cyber-note">命中 {filteredPosts.length} 篇文章</p>
					</div>
				</SidebarNav>
			</aside>

			<section class="terminal terminal-article">
				<div class="terminal-bar">
					<div class="terminal-title">tag</div>
				</div>
				<div class="terminal-body">
					<h1 class="taxonomy-title">#{tag}</h1>
					<p class="hero-sub">共 {filteredPosts.length} 篇文章</p>
					{filteredPosts.length ? (
						<ul class="post-list post-list--cards">
							{filteredPosts.map((post: CollectionEntry<'blog'>) => (
								<li class="post-card">
									<div class="post-card-head">
										<span class="post-card-id">ID {post.data.id}</span>
										<span class="post-card-date"><FormattedDate date={post.data.pubDate} /></span>
									</div>
									<a class="post-card-title" href={getPostPath(post.data.id)}>{post.data.title}</a>
									<div class="post-meta post-card-desc">
										<FormattedDate date={post.data.pubDate} /> 路 {post.data.description}
									</div>
									{(post.data.category || post.data.tags?.length) && (
										<div class="post-meta taxonomy-links">
											{post.data.category && (
												<a href={`/blog/categories/${encodeCategoryPath(post.data.category)}/`}>
													{post.data.category}
												</a>
											)}
											{post.data.tags?.slice(0, 3).map((postTag) => (
												<a href={`/blog/tags/${encodeTag(postTag)}/`}>#{postTag}</a>
											))}
										</div>
									)}
								</li>
							))}
						</ul>
					) : (
						<p class="hero-sub">暂无文章</p>
					)}
				</div>
			</section>
		</main>
	</body>
</html>

