---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import SidebarNav from '../../../components/SidebarNav.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import {
	buildCategoryDirectory,
	encodeCategoryPath,
	normalizeCategoryPath,
} from '../../../utils/categoryDirectory';

const posts = await getCollection('blog');
const directory = buildCategoryDirectory(posts);

const rootItems = directory.filter((item) => item.depth === 0);
const stats = {
	categoryCount: directory.length,
	postCount: posts.length,
	withCategoryCount: posts.filter((post) => normalizeCategoryPath(post.data.category ?? '')).length,
};

const childrenByParent = new Map<string, typeof directory>();
for (const item of directory) {
	if (!item.parentPath) {
		continue;
	}

	const children = childrenByParent.get(item.parentPath) ?? [];
	children.push(item);
	childrenByParent.set(item.parentPath, children);
}

for (const items of childrenByParent.values()) {
	items.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
}
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`${SITE_TITLE} / Categories`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<div class="noise-layer" aria-hidden="true"></div>
		<div class="data-stream" aria-hidden="true"></div>
		<main class="page page-grid page-grid--sticky-side page-grid--sticky-side-auto">
			<aside class="side-stack side-stack--blog-width">
				<SidebarNav
					actions={[
						{ href: '/', label: '首页' },
						{ href: '/blog/', label: '文章列表' },
						{ href: '/blog/tags/', label: '标签索引' },
					]}
				/>
				<section class="terminal sticky-side-panel">
					<div class="terminal-bar">
						<div class="terminal-title">stats</div>
					</div>
					<div class="terminal-body meta-list taxonomy-stats">
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">分类节点</span>
							<span class="taxonomy-stat-value">{stats.categoryCount}</span>
						</div>
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">文章总数</span>
							<span class="taxonomy-stat-value">{stats.postCount}</span>
						</div>
						<div class="taxonomy-stat-item">
							<span class="taxonomy-stat-label">带分类文章</span>
							<span class="taxonomy-stat-value">{stats.withCategoryCount}</span>
						</div>
					</div>
				</section>
			</aside>

			<section class="terminal terminal-article">
				<div class="terminal-bar">
					<div class="terminal-title">categories</div>
				</div>
				<div class="terminal-body">
					<h1 class="taxonomy-title">分类索引</h1>
					<p class="hero-sub">每个分类同时显示直属文章数与包含子分类后的总文章数。</p>

					{rootItems.length ? (
						<div class="category-directory-grid">
							{rootItems.map((root) => {
								const children = childrenByParent.get(root.path) ?? [];

								return (
									<article class="category-directory-card">
										<header class="category-directory-head">
											<a
												class="category-directory-title"
												href={`/blog/categories/${encodeCategoryPath(root.path)}/`}
											>
												{root.name}
											</a>
											<div class="category-directory-counts">
												<span>直属 {root.directCount}</span>
												<span>总计 {root.totalCount}</span>
											</div>
										</header>

										{children.length ? (
											<ul class="category-directory-children">
												{children.map((child) => (
													<li>
														<a href={`/blog/categories/${encodeCategoryPath(child.path)}/`}>
															{child.name}
															<span class="category-directory-child-count">
																{child.totalCount}
															</span>
														</a>
													</li>
												))}
											</ul>
										) : (
											<p class="hero-sub category-empty-sub">暂无子分类</p>
										)}
									</article>
								);
							})}
						</div>
					) : (
						<p class="hero-sub">暂无分类</p>
					)}
				</div>
			</section>
		</main>
	</body>
</html>
