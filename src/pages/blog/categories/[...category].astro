---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import MobileSideToggle from '../../../components/MobileSideToggle.astro';
import PostCard from '../../../components/PostCard.astro';
import SidebarNav from '../../../components/SidebarNav.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../../consts';
import {
	sortPostsByPriority,
} from '../../../utils/blogTaxonomy';
import {
	buildCategoryBreadcrumb,
	buildCategoryDirectory,
	encodeCategoryPath,
	filterPostsByCategory,
	normalizeCategoryPath,
} from '../../../utils/categoryDirectory';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const directory = buildCategoryDirectory(posts);

	return directory.map((item) => ({
		params: { category: item.path },
		props: { categoryPath: item.path },
	}));
}

type Props = {
	categoryPath: string;
};

const { categoryPath } = Astro.props as Props;
const normalizedCategoryPath = normalizeCategoryPath(categoryPath);

const posts = sortPostsByPriority(await getCollection('blog'));
const directory = buildCategoryDirectory(posts);

const currentCategory = directory.find((item) => item.path === normalizedCategoryPath) ?? null;
if (!currentCategory) {
	throw new Error(`Category not found: ${normalizedCategoryPath}`);
}

const directPosts = filterPostsByCategory(posts, normalizedCategoryPath, 'direct');
const treePosts = filterPostsByCategory(posts, normalizedCategoryPath, 'tree');
const breadcrumb = buildCategoryBreadcrumb(normalizedCategoryPath);
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead
			title={`${SITE_TITLE} / Category / ${normalizedCategoryPath}`}
			description={SITE_DESCRIPTION}
		/>
	</head>
	<body>
		<div class="noise-layer" aria-hidden="true"></div>
		<div class="data-stream" aria-hidden="true"></div>
		<main class="page page-grid page-grid--sticky-side page-grid--sticky-side-auto" data-mobile-side-toggle-root>
			<MobileSideToggle label="侧栏" openLabel="关闭" />
			<aside class="side-stack side-stack--blog-width" style="--side-panels:1;">
				<SidebarNav
					cyber
					actions={[
						{ href: '/blog/', label: '查看文章列表' },
						{ href: '/blog/categories/', label: '返回分类索引' },
					]}
				>
					<div slot="context" class="nav-cyber-context nav-cyber-context--path">
						<p class="nav-cyber-kicker">ACTIVE PATH</p>
						<div class="tag-list tag-list--breadcrumbs nav-cyber-path">
							{breadcrumb.map((item) => (
								<a class="tag nav-cyber-path-tag" href={`/blog/categories/${encodeCategoryPath(item.path)}/`}>
									{item.name}
								</a>
							))}
						</div>
						<p class="nav-cyber-note">直属 {directPosts.length} · 总计 {treePosts.length}</p>
					</div>
				</SidebarNav>
			</aside>

			<section class="terminal terminal-article">
				<div class="terminal-bar">
					<div class="terminal-title">category</div>
				</div>
				<div class="terminal-body">
					<h1 class="taxonomy-title">{normalizedCategoryPath}</h1>
					<p class="hero-sub">直属文章 {directPosts.length} 篇 · 含子分类 {treePosts.length} 篇</p>

					{treePosts.length ? (
						<ul class="post-list post-list--cards category-post-list">
							{treePosts.map((post: CollectionEntry<'blog'>) => (
								<PostCard post={post} descriptionSeparator="路" />
							))}
						</ul>
					) : (
						<p class="hero-sub">暂无文章</p>
					)}
				</div>
			</section>
		</main>
	</body>
</html>

